const uploadBox = document.getElementById('uploadBox');
const imageUpload = document.getElementById('imageUpload');

uploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
});

uploadBox.addEventListener('dragleave', () => {
    uploadBox.classList.remove('dragover');
});

uploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');

    const file = e.dataTransfer.files[0];
    if (file) {
        handleImageUpload(file);
    }
});

uploadBox.addEventListener('click', () => {
    imageUpload.click();
});

imageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        handleImageUpload(file);
    }
});

function handleImageUpload(file) {
    const img = new Image();
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    const matrixContainer = document.getElementById('matrix');

    img.onload = function() {
        if (img.width !== img.height) {
            alert("The image is not 1:1 ratio! Please upload a profile picture.");
            matrixContainer.innerHTML = '';
            return;
        }

        canvas.width = 30;
        canvas.height = 30;
        ctx.drawImage(img, 0, 0, 30, 30);

        const imageData = ctx.getImageData(0, 0, 30, 30);
        const data = imageData.data;

        matrixContainer.innerHTML = '';
        let formattedMatrix = [];

        for (let y = 0; y < 30; y++) {
            for (let x = 0; x < 30; x++) {
                const index = (y * 30 + x) * 4;
                const r = data[index];
                const g = data[index + 1];
                const b = data[index + 2];

                const rStr = r.toString().padStart(3, '0');
                const gStr = g.toString().padStart(3, '0');
                const bStr = b.toString().padStart(3, '0');
                formattedMatrix.push(`${rStr}${gStr}${bStr}`);

                const color = `rgb(${r}, ${g}, ${b})`;
                const pixelDiv = document.createElement('div');
                pixelDiv.className = 'pixel';
                pixelDiv.style.backgroundColor = color;
                matrixContainer.appendChild(pixelDiv);
            }
        }

        matrixContainer.style.animation = 'none';
        setTimeout(() => {
            matrixContainer.style.animation = 'spreadAndShrink 3s';
        }, 10);

        const formattedMatrixText = formattedMatrix.join(',');
        console.log("Matrix:");
        console.log(formattedMatrixText);
        setTimeout(() => {
            compareMatrix(formattedMatrixText);
        }, 3000);
    };

    const reader = new FileReader();
    reader.onload = function(event) {
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);
}

function calculateColorDistance(color1, color2) {
    //Calculate similarity of uploaded pictured to bartosz using euclidean similarity
    const r1 = parseInt(color1.slice(0, 3), 10);
    const g1 = parseInt(color1.slice(3, 6), 10);
    const b1 = parseInt(color1.slice(6, 9), 10);

    const r2 = parseInt(color2.slice(0, 3), 10);
    const g2 = parseInt(color2.slice(3, 6), 10);
    const b2 = parseInt(color2.slice(6, 9), 10);

    return Math.sqrt(Math.pow(r1 - r2, 2) + Math.pow(g1 - g2, 2) + Math.pow(b1 - b2, 2));
}

function compareMatrix(matrix) {
    const comparisonMatrix = `248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,247000000,232000000,224000000,227000000,248000000,247000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,235001000,213001000,206001000,213016009,089011003,015003006,054006010,200002005,210001000,239001001,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,179009004,047005004,015016015,076077076,072074071,026028026,063064060,002001001,033002003,169023024,219029026,241033030,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,207001000,140007005,036003003,041042040,058060056,054054053,003003003,020020017,022023022,015015014,083084080,108113105,189133121,237028023,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,246001000,110002000,011009006,004004004,026026025,036037035,054055053,003003002,063064060,077077074,037038038,083083079,084084080,107104097,189076069,247000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,241000000,235001003,191002003,060001001,012012012,005005005,038038037,053053052,040040038,003003002,047048047,078078075,068069066,059059055,084085080,077077073,121055052,223024020,247000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,239000001,231002002,121002002,010009010,006006006,000000000,000000000,000000000,039039037,003003003,044045042,079080076,069070066,047046045,084084080,063063060,064059058,180050048,249001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,189000000,056001000,007008008,011011011,003003003,000000000,000000000,001001000,000000000,081082078,069069066,083084081,077078076,084085081,057057055,042042041,169105098,250054049,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,161000000,024000000,001001001,008008008,011011011,002002002,000000000,000000000,001001001,033035032,068068066,041042040,083085081,084085081,059060059,022022020,077069063,191047038,246001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,246001000,192026025,064029030,001001001,002002002,032032032,010010010,000000000,030031030,071071069,005005005,057057055,063063060,083085080,084085082,057058055,005005004,009006007,145006004,246001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,247001000,173008004,038009007,000000000,000000000,009009009,003003003,000000000,012013012,088088085,065066063,075076072,083084080,079079077,070070067,078079076,040041040,056010007,185003002,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,232001000,105002000,000000001,000000000,000000000,000000000,001001000,041041040,016017016,090090089,083083079,075076072,021023020,032032029,015015013,040040038,121041038,214004002,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,247002000,168037035,056048048,029029029,008008008,001001001,000000000,006006005,075078075,017014013,085086083,082083081,078078077,069069066,073073071,046045044,127006003,245001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,245001000,182023020,051020020,036038038,042042042,008008008,044046043,082082080,006006004,005003004,003003003,003003003,004004004,014014013,027028026,027026027,151027028,247000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,246000000,240000000,237000000,150001001,001003004,006003001,014005005,101087085,153137131,047049044,124113107,207199193,199201195,100100096,005004002,008008008,029028027,004001000,024024024,036036036,000001002,137004002,246002000,248000000,248000000,248000000,248000000,248000000,251000001,243003002,204005005,063000000,023003004,031017019,052046048,141027023,096003000,086075070,134119111,216205194,241231216,240230215,238230218,239232222,094093089,076076073,151148144,002003000,004004004,005005005,000000000,067054047,200035030,248000000,248000000,248000000,248000000,248000000,246002002,241002004,247000001,246001000,245002000,187017019,143024023,140002000,028001002,082069066,207196184,241231217,240231216,240231216,238230215,239227215,211202191,085079073,115109106,012012012,002002002,001001001,000001001,097008004,219005002,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,228002001,205003002,189002000,087001001,061000000,028000003,132127123,227219206,240231216,240231216,240231216,239229214,195188175,239231219,155153148,019023022,000000000,002002002,030006006,166003002,249000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,246001000,238006003,189006004,127004000,206002000,180000000,171001000,063003000,004003003,184178169,240231216,240231216,241231217,165159149,099091082,177176166,077089090,002009010,004005004,041042040,156043039,240001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,240003001,199017018,205010016,222005004,125001000,018001000,050002005,032001003,004001002,186179169,224216205,159153144,168163156,039045046,175175169,079093096,050057060,014018019,026030030,088090088,200078072,247001000,248000000,248000000,248000000,248000000,248000000,248000000,248000000,234001000,165000000,205009014,200007012,210014017,169007005,066000000,090000000,055000001,000000000,104100094,110107103,010011011,046050052,090107110,064074078,061071072,026027028,046049050,043047048,028031032,135014013,247001000,248000000,248000000,248000000,248000000,248000000,248000000,244001000,121002002,140000000,156002000,232008007,209015014,173015016,145004000,073000000,008000000,000000000,022023025,006005007,000001001,050052055,069081082,034039041,043048048,044049049,035039040,024028028,035039039,140027027,241000000,248000000,248000000,248000000,248000000,248000000,248000000,109001005,150001003,221004007,167002001,204006004,166006001,190038033,157061058,076022020,000000000,000000000,020021023,029029031,016018019,045049050,046052052,045051051,042047047,025028029,028032033,016020020,046050050,142098089,243062054,248000000,248000000,248000000,248000000,248000000,248000000,162000000,247001000,236004008,198006012,106008002,082003002,203054054,128073072,018014013,000000001,019022023,008009011,025028029,037042042,044050050,045051051,043048048,016020020,012014016,020023024,023028028,030034035,103106095,203069062,244000001,248000000,248000000,248000000,248000000,248000000,184004006,248000000,238000000,165004002,065008008,077030032,158068070,048024025,000001001,023025026,020022023,016019020,033038039,044050050,045051051,043049049,042045045,001002002,008009010,015019019,007011011,020025025,055060057,162128115,246064057,248000000,248000000,248000000,248000000,248000000,117046040,208008014,057003000,037001000,015002002,022009010,040016017,007004005,002004005,021025027,010012013,005006008,036038039,046050051,042047047,011012012,010010010,000000000,002002002,004005005,004005005,025029030,045051050,071078074,183036035,245000001,248000000,248000000,248000000,248000000,158101103,036002003,000001000,000000000,000000001,001000002,023021022,024024025,002001002,009013016,016023025,038042044,014016017,008009009,007008008,000000000,000000000,000000000,000000000,000000000,014016016,040045046,043049049,045051051,060039043,194011011,248000000,248000000,248000000,248000000,017011012,000000000,001002003,000002001,000000000,000000001,003003003,003003003,000001002,025035036,041055056,167106112,035021022,000000000,000000000,000000000,000000000,000000000,000000000,001001002,018021022,044049050,045050051,046052052,044050050,166023026,241003003,248000000,248000000,248000000,003003001,000001001,004005006,001000000,004000001,001000000,000000000,000000000,029031032,048057061,013021023,160098102,072065065,003006005,000000000,000000000,000000000,000000000,000000000,000001000,017020020,045051051,024027028,027031032,045051051,049050048,204014007,248000000,248000000,248000000`; // Replace with your actual comparison matrix
    const matrixArray = matrix.split(',');
    const comparisonArray = comparisonMatrix.split(',');
    const totalPixels = matrixArray.length;
    let totalDistance = 0;
    const threshold = 50;
    matrixArray.forEach((value, index) => {
        const color1 = value;
        const color2 = comparisonArray[index];
        const distance = calculateColorDistance(color1, color2);
        totalDistance += distance;
    });

    const averageDistance = totalDistance / totalPixels;
    
    const maxDistance = Math.sqrt(Math.pow(255, 2) * 3);
    const similarityPercentage = (1 - (averageDistance / maxDistance)) * 100;

    console.log(`Average Color Distance: ${averageDistance.toFixed(2)}`);
    console.log(`Similarity: ${similarityPercentage.toFixed(2)}%`);

    if (similarityPercentage > 85) {
        alert(`Bartosz!!🙀\nSimilarity: ${similarityPercentage.toFixed(2)}%`);
    } else {
        const audio = new Audio('sus.mp3');
        audio.play();
        
        audio.onended = () => {
            const popup = document.createElement('div');
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '1000';
            popup.style.backgroundColor = 'white';
            popup.style.border = '2px solid black';
            popup.style.padding = '20px';
            popup.style.boxShadow = '0px 0px 10px rgba(0, 0, 0, 0.5)';
            popup.style.textAlign = 'center';
            const image = new Image();
            image.src = 'impostor.png';
            image.style.maxWidth = '100%';
            image.style.maxHeight = '100%';
            popup.appendChild(image);
            document.body.appendChild(popup);
            alert(`Not Bartosz❗\nSimilarity: ${similarityPercentage.toFixed(2)}%`);
            document.body.removeChild(popup);
        };
    }
}


